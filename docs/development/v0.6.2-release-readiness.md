# v0.6.2 Release Readiness Assessment

**Date**: January 19, 2026  
**Target**: Stable bugfix release before v0.7.0-beta  
**Status**: üü° **IN PROGRESS** - 2 critical bugs remain, 4 bugs fixed today

---

## Executive Summary

**Current State**: v0.6.1 has production-ready core functionality but contains bugs that block important query patterns. Fixed 4 bugs today (Bug #9, #10, #11, #14) during systematic integration testing.

**Test Status** (Jan 19, 2026 - 12:47 PM):
- ‚úÖ Unit tests: 770/770 passing (100%)
- üü° Integration tests: **104/354 passing (29.4%)** - systematic bug fixing in progress
  - TestBasicPatterns: ‚úÖ All passing (24/24)
  - TestMultiHopPatterns: ‚úÖ All passing (16/16)
  - TestVariableLengthPaths: ‚úÖ All passing (16/16)
  - TestShortestPath: ‚ö†Ô∏è Skipped (performance issue - memory exhaustion)
  - TestOptionalMatch: ‚úÖ **All passing (6/6)** - Bug #11 fixed!
  - TestWithChaining: ‚ùå All xfail (0/12) - Bug #3 (duplicate CTE names)
  - TestAggregations: ‚úÖ Most passing (12/17)
  - TestGroupBy: ‚úÖ **Most passing (3/4)** - Bug #14 fixed!
  - TestOrdering: ‚úÖ All passing (6/8, 2 zeek skipped)
  - TestExpressions: ‚úÖ All passing (18/24, 6 zeek skipped)
  - TestMultiplePatterns: ‚úÖ All passing (2/2 xpassed!)
  - TestFunctions: ‚úÖ Most passing (10/12)
- ‚úÖ Bug #9 (duplicate alias): **FIXED** (Jan 19)
- ‚úÖ Bug #10 (WHERE duplication): **FIXED** (Jan 19)
- ‚úÖ Bug #11 (anyLast wrapping): **FIXED** (Jan 19)
- ‚úÖ Bug #14 (missing FROM with GROUP BY): **FIXED** (Jan 19)

**Critical Path**: Fix remaining bugs ‚Üí Validate with integration tests ‚Üí Release v0.6.2

---

## Known Bugs for v0.6.2

### 1. üî• **CRITICAL**: Missing anyLast() Wrapping for GROUP BY Queries

**Priority**: HIGH (blocks OPTIONAL MATCH + aggregation)  
**Status**: ‚úÖ **FIXED** (Jan 19, 2026)

**Symptom**:
```cypher
MATCH (a:User) WHERE a.country >= 'test' 
OPTIONAL MATCH (a)-[r:FOLLOWS]->(b) 
RETURN a, count(b) as cnt 
LIMIT 10
```
**Error**: `Code: 215. DB::Exception: Column 'a.city' is not under aggregate function and not in GROUP BY keys`

**Root Cause**:
- When `RETURN a` is expanded to all properties (`a.city`, `a.country`, `a.email`, etc.)
- AND there's an aggregation (`count(b)`) causing GROUP BY
- The GROUP BY optimization only includes ID column (`GROUP BY a.user_id`)
- But SELECT includes ALL columns without `anyLast()` wrapping
- ClickHouse requires: non-aggregated, non-grouped columns must use aggregate functions

**Generated SQL** (broken):
```sql
SELECT 
  a.city AS "a.city",         -- ‚ùå Not in GROUP BY, not wrapped
  a.country AS "a.country",   -- ‚ùå Not in GROUP BY, not wrapped
  a.user_id AS "a.user_id",   -- ‚úÖ In GROUP BY (OK)
  count(b.user_id) AS "cnt"   -- ‚úÖ Aggregate function (OK)
FROM users_bench AS a
LEFT JOIN user_follows_bench AS r ...
GROUP BY a.user_id  -- Only ID column
LIMIT 10
```

**Should Generate**:
```sql
SELECT 
  anyLast(a.city) AS "a.city",         -- ‚úÖ Wrapped
  anyLast(a.country) AS "a.country",   -- ‚úÖ Wrapped
  a.user_id AS "a.user_id",             -- ‚úÖ In GROUP BY
  count(b.user_id) AS "cnt"             -- ‚úÖ Aggregate
FROM users_bench AS a
LEFT JOIN user_follows_bench AS r ...
GROUP BY a.user_id
LIMIT 10
```

**Impact**:
- **Severity**: HIGH - Blocks OPTIONAL MATCH + aggregation + RETURN node
- **Frequency**: HIGH - Common pattern in analytics
- **Workaround**: Return only specific properties instead of entire node
- **Blocked queries**: `RETURN a, count(b)`, `RETURN n, avg(r.weight)`
- **Test Impact**: Blocks TestOptionalMatch::test_optional_match_with_filter (3/4 tests)

**Technical Details**:
- Issue discovered during systematic integration testing (Jan 19)
- Existing `anyLast()` infrastructure in `property_expansion.rs` works correctly
- Problem: `expand_alias_to_select_items_unified()` not being called for `RETURN a` expansion
- Current code path: `select_builder.rs` manually expands without aggregation context
- Fix location: `render_plan/plan_builder.rs::to_render_plan()` - post-process SELECT items after extracting GROUP BY

**Fix Strategy** (Implemented):
1. ‚úÖ Added helper function `apply_anylast_wrapping_for_group_by()` in `plan_builder.rs`
2. ‚úÖ Called after extracting SELECT items and GROUP BY in `to_render_plan()` (lines ~720, ~750)
3. ‚úÖ For each SELECT item that is `PropertyAccessExp`:
   - Skip if already an aggregate function
   - Skip if in GROUP BY expressions  
   - Skip if ID column (ends with `_id`, `.id`, or equals `id`)
   - Otherwise wrap with `anyLast(PropertyAccessExp)`
4. ‚úÖ Tested: All TestOptionalMatch tests now passing (6/6)

**Files Modified**:
- `src/render_plan/plan_builder.rs` - Added post-processing function (lines 102-198)
- Applied in both GraphJoins and GraphRel cases (lines ~720, ~750)

**Test Results**:
- ‚úÖ TestOptionalMatch: 6/6 passing (was 3/6 before fix)
- ‚úÖ Generated SQL correctly includes `anyLast()` for non-ID columns
- ‚úÖ ID columns remain unwrapped in SELECT
- ‚úÖ Aggregate functions remain unchanged

**Estimated Fix Time**: 1-2 days  ‚úÖ **ACTUAL: 4 hours**

**Related Functionality**:
- ‚úÖ Works in CTEs (existing code in CTE generation)
- ‚úÖ Works when called via `expand_alias_to_select_items_unified()`  
- ‚ùå Broken in main SELECT when `RETURN a` is expanded

---

### 2. üî• **CRITICAL**: OPTIONAL MATCH + VLP Combination

**Priority**: HIGH (blocks multiple query patterns)  
**Status**: üêõ **UNFIXED**

**Symptom**:
```cypher
MATCH (a:User) WHERE a.name = 'Alice'
OPTIONAL MATCH (a)-[:FOLLOWS*1..2]->(b:User)
RETURN a.name, COUNT(DISTINCT b) as reachable
```
**Error**: `Identifier 'vlp66.name' cannot be resolved from subquery`

**Root Cause**:
- VLP (variable-length path) alias rewriting incorrectly maps `a.name` ‚Üí `vlp66.name` in outer query
- When VLP is inside OPTIONAL MATCH, the alias rewriting breaks scoping rules
- The VLP CTE generates internal aliases like `vlp66` that leak into the outer query

**Impact**:
- **Severity**: HIGH - Blocks combination of two important features
- **Frequency**: LOW - Specific pattern (OPTIONAL + VLP)
- **Workaround**: Avoid using VLP inside OPTIONAL MATCH
- **Blocked queries**: Social network reachability with optional paths

**Files Involved**:
- `src/render_plan/cte_extraction.rs` - VLP alias generation
- `src/render_plan/plan_builder.rs` - Alias rewriting logic

**Estimated Fix Time**: 2-3 days
- Day 1: Debug alias scoping in OPTIONAL context
- Day 2: Implement proper VLP alias isolation
- Day 3: Test and validate fix

---

### 3. üî• **CRITICAL**: Duplicate CTE Names with Chained WITH

**Priority**: HIGH (blocks common patterns)  
**Status**: üêõ **UNFIXED**

**Symptom**:
```cypher
MATCH (m:Message)
WITH count(m) AS total
MATCH (m:Message)
WITH total, count(m) AS cnt
RETURN total, cnt
```
**Error**: `Syntax error: failed at position 362` (duplicate CTE name)

**Root Cause**:
- CTE naming logic generates the same name (`with_total_cte_1`) for both WITH clauses
- When reusing scalar aggregates from previous WITH, the naming collides
- ClickHouse rejects SQL with duplicate CTE names

**Generated SQL** (broken):
```sql
WITH with_total_cte_1 AS (SELECT COUNT(...) AS total FROM ...),
     with_total_cte_1 AS (SELECT total, COUNT(...) AS cnt FROM ...)  -- ‚ùå DUPLICATE
SELECT total, cnt FROM with_total_cte_1
```

**Impact**:
- **Severity**: HIGH - Blocks chained aggregations
- **Frequency**: MEDIUM - Common in analytics queries
- **Workaround**: Avoid reusing scalar aggregate aliases across multiple WITH clauses
- **Blocked queries**: Multi-stage aggregations, running totals

**Files Involved**:
- `src/render_plan/plan_builder.rs` - CTE naming in `build_chained_with_match_cte_plan()`
- `src/utils/cte_naming.rs` - CTE name generation logic

**Previous Fix Attempt** (Jan 11, 2026):
- Tried treating scalars differently in TableAlias expansion
- **Failed**: Caused relationship return bugs
- **Lesson**: CTE naming needs context about previous WITH clauses

**Estimated Fix Time**: 2-3 days
- Day 1: Design deterministic naming with context tracking
- Day 2: Implement name uniqueness check
- Day 3: Test chained WITH patterns

---

### 4. ‚ö° **PERFORMANCE**: Shortest Path Memory Exhaustion on Large Graphs

**Priority**: MEDIUM (performance optimization)  
**Status**: üêõ **IDENTIFIED** (Jan 19, 2026)

**Symptom**:
```cypher
MATCH p = shortestPath((a:User)-[:FOLLOWS*]->(b:User)) 
WHERE a.user_id = 1 
RETURN p LIMIT 10
```
**Error**: `Code: 241. DB::Exception: memory limit exceeded: would use 70.69 GiB`

**Root Cause**:
- Shortest path without end node filter explores ALL paths from start to all reachable nodes
- Query tracks millions of paths simultaneously before applying LIMIT
- ClickHouse memory limit (70.69 GiB) exceeded on large social networks
- No early termination optimization when LIMIT is reached

**Generated SQL** (syntactically correct):
```sql
-- CTE correctly includes start filter
WHERE start_node.user_id = 1

-- Outer query correctly has no WHERE clause (Bug #10 fixed)
SELECT p.* FROM vlp_a_b AS p LIMIT 1
```

**Impact**:
- **Severity**: MEDIUM - SQL is correct, but impractical for large graphs
- **Frequency**: LOW - Only affects shortest path on large graphs without end filter
- **Workaround**: Add end node filter (e.g., `WHERE a.user_id = 1 AND b.user_id = 100`)
- **Blocked queries**: TestShortestPath integration test class
- **Category**: Performance optimization, not syntax bug

**Fixes Required (Bugs #9 & #10)**:
- ‚úÖ Bug #9: Path variable duplicate alias (`SELECT p.*` instead of `SELECT p AS "p"`)
- ‚úÖ Bug #10: WHERE clause duplication (skip GraphRel filter extraction for VLP/shortest path)
- **Both bugs fixed Jan 19** - SQL generation now correct

**Potential Solutions** (future optimization work):
- Implement early termination when LIMIT rows are reached
- Add bidirectional search optimization (meet-in-middle)
- Require end node filter for large graphs
- Add query-level resource limits/timeouts
- Stream results instead of materializing all paths

**Files Involved**:
- `src/clickhouse_query_generator/to_sql_query.rs` - Bug #9 fix (SELECT items)
- `src/render_plan/filter_builder.rs` - Bug #10 fix (GraphRel filter extraction)
- `src/query_planner/optimizer/` - Future optimization passes

**Estimated Fix Time**: 4-5 days (future work)
- Day 1: Design early termination strategy
- Day 2: Implement bidirectional search
- Day 3-4: Add streaming result support
- Day 5: Test and validate performance gains

**Status**: Deferred to future optimization work (post-v0.6.2)

---

## Recently Fixed (v0.6.1 ‚Üí v0.6.2)

### ‚úÖ Bug #11: Missing anyLast() Wrapping for GROUP BY (Fixed Jan 19)
- **Was**: `RETURN a, count(b)` failed with "Column not under aggregate function"
- **Fix**: Post-process SELECT items to wrap non-ID, non-aggregated columns with `anyLast()` when GROUP BY present
- **Impact**: Unblocked OPTIONAL MATCH + aggregation + RETURN node (TestOptionalMatch now 6/6 passing)
- **File**: `src/render_plan/plan_builder.rs` (added 102 lines)
- **Time**: 4 hours (faster than 1-2 day estimate)

### ‚úÖ Bug #14: Missing FROM Clause with GROUP BY (Fixed Jan 19)
- **Was**: Single-node queries with GROUP BY failed with missing FROM clause
- **Example**: `MATCH (n:User) RETURN n.name, count(*)` generated SQL without FROM
- **Root Cause**: `find_graph_node()` helper couldn't traverse through `GroupBy` logical plan nodes
- **Fix**: Added `LogicalPlan::GroupBy` case to traverse helper in `extract_from_graph_joins()`
- **Impact**: Unblocked single-node aggregation queries (TestGroupBy now 3/4 passing)
- **File**: `src/render_plan/from_builder.rs` (1 line added at line 554)
- **Time**: 30 minutes

### ‚úÖ Bug #9: Path Variable Duplicate Alias (Fixed Jan 19)
- **Was**: `RETURN p` failed with "Already registered p AS p" error
- **Fix**: Render path variable as `p.*` instead of `p AS "p"` in SELECT
- **Impact**: Unblocked path variable queries with shortest path/VLP

### ‚úÖ Bug #10: WHERE Clause Duplication in VLP (Fixed Jan 19)
- **Was**: VLP queries failed with "Unknown identifier a.user_id" in outer SELECT
- **Fix**: Skip GraphRel filter extraction for VLP/shortest path (filters already in CTE)
- **Impact**: Proper WHERE clause scoping for variable-length path queries

### ‚úÖ MULTI_TABLE_LABEL Node Expansion (Fixed Jan 12)
- **Was**: `RETURN n` failed with dotted column names (e.g., `id.orig_h`)
- **Fix**: Changed column name extraction to preserve dotted columns
- **Impact**: Unblocked 78 zeek schema tests

### ‚úÖ WITH Clause Expression Scope (Fixed Jan 12)
- **Was**: CASE expressions in WITH failed with "Unknown expression identifier"
- **Fix**: Rewrite both column names AND table aliases to CTE names
- **Impact**: Fixed IC-4 pattern queries

### ‚úÖ CTE Column Reference (Fixed Jan 12)
- **Was**: Dotted vs underscore column naming inconsistency
- **Fix**: Distinguish UNION vs CTE column references
- **Impact**: Proper column name normalization

### ‚úÖ VLP CTE Column Scoping (Fixed Jan 12)
- **Was**: VLP + aggregation failed with missing column errors
- **Fix**: Include aggregate-referenced columns in UNION SELECT
- **Impact**: Unblocked IC-3, IC-9, BI-2, BI-9

### ‚úÖ WITH + MATCH CartesianProduct (Fixed Jan 12)
- **Was**: Disconnected MATCH patterns with WITH failed
- **Fix**: Handle CartesianProduct in WITH clause traversal
- **Impact**: Support complex multi-MATCH queries

---

## Test Coverage Assessment

### Unit Tests ‚úÖ
- **Status**: 770/770 passing (100%)
- **Coverage**: Excellent for core functionality
- **Gap**: Need specific tests for the 2 known bugs

### Integration Tests ‚ö†Ô∏è
- **Status**: Blocked by ClickHouse authentication
- **Issue**: `test_user` authentication failed
- **Action Required**: Fix test setup before validating fixes
- **Files**: `tests/integration/matrix/test_comprehensive.py`

### LDBC SNB Benchmark ‚ö†Ô∏è
- **Status**: 15/41 queries passing (37%)
- **Blockers**: VLP scoping issues affect several queries
- **Expectation**: Should improve to 20+/41 after bug fixes

---

## Release Readiness Checklist

### Pre-Development
- [ ] **Environment Setup**
  - [ ] Fix ClickHouse integration test authentication
  - [ ] Verify test database setup
  - [ ] Configure test environment variables

### Bug Fix Phase (Week 1)
- [ ] **Bug #1: OPTIONAL MATCH + VLP**
  - [ ] Debug VLP alias scoping
  - [ ] Implement VLP alias isolation
  - [ ] Add unit test: `test_optional_match_vlp_combination()`
  - [ ] Add integration test: `test_optional_vlp_integration.py`
  - [ ] Verify no regression in existing VLP tests

- [ ] **Bug #2: Duplicate CTE Names**
  - [ ] Design context-aware CTE naming
  - [ ] Implement name uniqueness tracking
  - [ ] Add unit test: `test_chained_with_scalar_aggregates()`
  - [ ] Add integration test: `test_chained_with_aggregation.py`
  - [ ] Verify no regression in existing WITH tests

### Validation Phase (Week 2)
- [ ] **All Tests Passing**
  - [ ] Unit tests: 770+ passing
  - [ ] Integration tests: Authentication fixed, core tests passing
  - [ ] LDBC benchmark: 20+/41 queries passing
  - [ ] No new warnings or errors

- [ ] **Documentation**
  - [ ] Update KNOWN_ISSUES.md (move bugs to "Recently Fixed")
  - [ ] Update CHANGELOG.md with v0.6.2 entry
  - [ ] Update STATUS.md with test statistics
  - [ ] Document fixes in commit messages

### Release Phase (Week 2)
- [ ] **Pre-Release**
  - [ ] Code review of bug fixes
  - [ ] Performance validation (no regression)
  - [ ] Create v0.6.2 branch
  - [ ] Final test run

- [ ] **Release**
  - [ ] Tag v0.6.2
  - [ ] Create GitHub release with notes
  - [ ] Update main README with v0.6.2
  - [ ] Announce bugfix release

---

## Risk Assessment

### Low Risk Items ‚úÖ
- Unit test coverage is excellent
- Core functionality is stable
- Recent fixes (Jan 12) are well-tested

### Medium Risk Items ‚ö†Ô∏è
- **Integration test setup**: Needs fixing before validation
- **CTE naming logic**: Complex area, careful testing needed
- **VLP alias scoping**: Touches critical path code

### High Risk Items üî•
- **None identified**: Bugs are isolated to specific patterns

### Mitigation Strategies

1. **Integration Test Setup**
   - Fix authentication before starting bug fixes
   - Ensures we can validate fixes immediately

2. **Incremental Testing**
   - Fix one bug at a time
   - Run full test suite after each fix
   - Don't proceed if tests fail

3. **Regression Prevention**
   - Add specific tests for each bug before fixing
   - Keep tests in place for future validation

---

## Timeline Estimate

### Option 1: Quick Release (1-2 weeks)
- **Week 1**: Fix integration tests + Bug #2 (duplicate CTE names)
- **Week 2**: Validate, document, release v0.6.2
- **Defer**: Bug #1 (OPTIONAL + VLP) to v0.6.3
- **Pros**: Faster release, lower risk
- **Cons**: Still have 1 known bug

### Option 2: Complete Fix (2-3 weeks)  ‚≠ê **RECOMMENDED**
- **Week 1**: Fix integration tests + both bugs
- **Week 2**: Comprehensive testing and validation
- **Week 3**: Documentation and release v0.6.2
- **Pros**: Clean release, all bugs fixed
- **Cons**: Slightly longer timeline

### Option 3: Minimal Release (1 week)
- **Week 1**: Just fix integration tests, release v0.6.1.1
- **Defer**: Both bugs to v0.6.3
- **Pros**: Fastest
- **Cons**: No real bug fixes, questionable value

---

## Recommendation

**Proceed with Option 2 (Complete Fix, 2-3 weeks)**:

1. **Week 1 (Jan 18-24)**:
   - Day 1-2: Fix integration test authentication
   - Day 3-4: Fix Bug #2 (duplicate CTE names) - higher priority
   - Day 5: Fix Bug #1 (OPTIONAL + VLP) or carry to Week 2

2. **Week 2 (Jan 25-31)**:
   - Day 1: Complete Bug #1 if needed
   - Day 2-3: Comprehensive testing (unit + integration + LDBC)
   - Day 4: Documentation updates
   - Day 5: Release preparation

3. **Week 3 (Feb 1-7)**: 
   - Release v0.6.2 early in week
   - Monitor for issues
   - Prepare for v0.7.0-beta later in week

**Rationale**:
- Fixes both critical bugs for a clean release
- Maintains quality standards
- Still gets to beta by early February
- Only 1 week slower than quick release

**Success Criteria for v0.6.2**:
- ‚úÖ 770+ unit tests passing
- ‚úÖ Integration tests working and passing
- ‚úÖ Both known bugs fixed and tested
- ‚úÖ LDBC benchmark: 20+/41 queries (up from 15/41)
- ‚úÖ No new regressions
- ‚úÖ Documentation complete

---

## Next Steps

1. **Immediate**: Fix integration test authentication
   ```bash
   # Check ClickHouse container
   docker ps | grep clickhouse
   
   # Verify test_user exists
   docker exec -it <container> clickhouse-client \
     --query "SELECT name FROM system.users"
   
   # Create test_user if missing
   docker exec -it <container> clickhouse-client \
     --query "CREATE USER IF NOT EXISTS test_user IDENTIFIED BY 'test_pass'"
   ```

2. **This Week**: Start Bug #2 fix (duplicate CTE names)
   - More common issue, affects more users
   - Cleaner fix path (naming logic is well-isolated)

3. **Next Week**: Bug #1 fix (OPTIONAL + VLP) 
   - More complex, touches VLP core
   - Can benefit from Bug #2 insights

4. **Document**: Update tracking as we progress
   - Daily progress notes
   - Test results
   - Blockers and solutions

Would you like to proceed with fixing the integration test authentication first?
