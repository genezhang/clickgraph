# Zeek DNS Log - Multi-Relationship Denormalized Edge Table Example
# 
# This schema demonstrates two relationship types from a single edge table,
# including a relationship that requires array flattening.
#
# Sample dns.log data:
# {
#   "ts": 1591367999.305988,
#   "uid": "CMdzit1AMNsmfAIiQc",
#   "id.orig_h": "192.168.4.76",      <- Source IP
#   "id.resp_h": "192.168.4.1",       <- DNS Server IP  
#   "query": "testmyids.com",         <- Domain queried
#   "qtype_name": "A",
#   "rcode_name": "NOERROR",
#   "answers": ["31.3.245.133"],      <- Resolved IPs (array!)
#   "TTLs": [3600]
# }
#
# Graph model:
#   Rule 1: (source_ip:IP)-[:REQUESTED]->(domain:Domain)
#           "192.168.4.76 requested testmyids.com"
#
#   Rule 2: (domain:Domain)-[:RESOLVED_TO]->(resolved_ip:IP)
#           "testmyids.com resolved_to 31.3.245.133"
#           NOTE: Requires ARRAY JOIN to flatten the answers array

name: zeek_dns_log
version: "1.0"

graph_schema:
  nodes:
    # IP node - appears as source in REQUESTED relationships
    - label: IP
      database: zeek
      table: dns_log
      id_column: ip
      property_mappings: {}
      
      from_node_properties:
        ip: "id.orig_h"
      
      to_node_properties:
        ip: "id.resp_h"  # Could be used for DNS server relationships

    # Domain node - queried domain names
    - label: Domain
      database: zeek
      table: dns_log  # Same table - domain is embedded
      id_column: name
      property_mappings: {}
      
      from_node_properties:
        name: query  # When domain is source (in RESOLVED_TO)
      
      to_node_properties:
        name: query  # When domain is target (in REQUESTED)

    # ResolvedIP node - resolved IP addresses from answers array
    # NOTE: This requires special handling for array flattening
    - label: ResolvedIP
      database: zeek
      table: dns_log
      id_column: ip
      property_mappings: {}
      
      # When ResolvedIP is the target of RESOLVED_TO, we need ARRAY JOIN
      to_node_properties:
        ip: answer  # After ARRAY JOIN, individual answer element
        # Note: The table needs to use ARRAY JOIN answers AS answer

  relationships:
    # REQUESTED relationship - "192.168.4.76 requested testmyids.com"
    - type: REQUESTED
      database: zeek
      table: dns_log
      from_id: "id.orig_h"
      to_id: query
      from_node: IP
      to_node: Domain
      
      edge_id: uid
      
      property_mappings:
        uid: uid
        timestamp: ts
        dns_server: "id.resp_h"
        qtype: qtype_name
        rcode: rcode_name
        rtt: rtt

    # RESOLVED_TO relationship - "testmyids.com resolved_to 31.3.245.133"
    # NOTE: This relationship requires array flattening via ClickHouse ARRAY JOIN
    - type: RESOLVED_TO
      database: zeek
      table: dns_log
      from_id: query
      to_id: answer  # This is the flattened element from answers array
      from_node: Domain
      to_node: ResolvedIP
      
      # Edge ID includes both uid and the specific answer for uniqueness
      edge_id: [uid, answer]
      
      # Array flattening configuration - NEW FEATURE
      # This tells ClickGraph to use ARRAY JOIN when querying this relationship
      array_flatten:
        source_column: answers    # The array column in the table
        flattened_alias: answer   # The alias for individual elements
      
      property_mappings:
        uid: uid
        timestamp: ts
        query: query
        ttl: ttl  # After ARRAY JOIN TTLs, individual TTL (if needed)
        rcode: rcode_name
