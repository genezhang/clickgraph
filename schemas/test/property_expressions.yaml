# Property Expressions Test Schema
# Tests expression-based property mappings in YAML configuration
# Uses users_expressions_test and follows_expressions_test tables

name: property_expressions
version: "1.0"

graph_schema:
  nodes:
    - label: User
      database: test_integration
      table: users_expressions_test
      node_id: user_id
      property_mappings:
        user_id: user_id
        # Expression: concat first_name and last_name
        full_name: "concat(first_name, ' ', last_name)"
        # Expression: concat with literal for display name
        display_name: "concat(first_name, ' (', city, ')')"
        # Expression: splitByChar to create array from CSV
        tags_array: "splitByChar(',', tags_str)"
        # Expression: array length
        tag_count: "length(splitByChar(',', tags_str))"
        # Simple fields
        city: city
        registration_date: registration_date
        # Expression: dateDiff for days since registration
        days_since_registration: "dateDiff('day', registration_date, today())"
        account_age_days: "dateDiff('day', registration_date, today())"
        # Expression: recent user check (within 30 days)
        is_recent_user: "dateDiff('day', registration_date, today()) <= 30"
        # Expression: type conversion from string
        birth_date: "toDate(birth_date_str)"
        age_uint8: "toUInt8(age_str)"
        age_int: "toUInt8(age_str)"
        score_float: "toFloat64(score_str)"
        # Expression: Simplified tier (CASE WHEN has parsing issues)
        tier: "if(score >= 1000, 'gold', if(score >= 500, 'silver', 'bronze'))"
        # Expression: Age group classification
        age_group: "if(toUInt8(age_str) < 18, 'minor', if(toUInt8(age_str) >= 65, 'senior', 'adult'))"
        # Expression: Priority based on multiIf (simulating status-like logic)
        priority: "multiIf(is_deleted = 1, 'low', is_banned = 1, 'low', is_active = 1, 'high', 'medium')"
        # Expression: multiIf for status
        status: "multiIf(is_deleted = 1, 'deleted', is_banned = 1, 'banned', is_active = 1, 'active', 'inactive')"
        # Expression: JSON extraction
        subscription_type: "JSONExtractString(metadata_json, 'subscription_type')"
        metadata_key: "JSONExtractString(metadata_json, 'subscription_type')"
        # Expression: mathematical operation
        normalized_score: "score / 100.0"
        score_normalized: "score / 1000.0"
        score_with_bonus: "score + 50"
        bonus_score: "score + 100"
        # Expression: boolean check
        has_premium: "is_premium"
        is_premium_bool: "is_premium"
        has_metadata: "length(metadata_json) > 2"

  edges:
    - type: FOLLOWS
      database: test_integration
      table: follows_expressions_test
      from_id: follower_id
      to_id: followed_id
      edge_id: follow_id
      from_node: User
      to_node: User
      property_mappings:
        follow_date: follow_date
        interaction_count: interaction_count
        # Expression: days since follow
        days_since_follow: "dateDiff('day', follow_date, today())"
        follow_age_days: "dateDiff('day', follow_date, today())"
        # Expression: recent follow check
        is_recent_follow: "dateDiff('day', follow_date, today()) <= 7"
        # Expression: relationship strength calculation
        strength: "interaction_count / 100.0"
        relationship_strength: "interaction_count / 100.0"
        # Expression: Simplified strength tier (CASE WHEN has parsing issues)
        strength_tier: "if(interaction_count >= 100, 'strong', if(interaction_count >= 50, 'medium', 'weak'))"
