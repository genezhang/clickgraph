# Test Schema for Zeek Merged Logs (DNS + Connection)
# Tests cross-table correlation patterns with denormalized IP nodes

name: zeek_merged_test
version: "1.0"

graph_schema:
  nodes:
    # IP in dns_log table
    - label: IP
      database: test_zeek
      table: dns_log
      id_column: ip
      property_mappings: {}
      from_node_properties:
        ip: orig_h
      to_node_properties:
        ip: resp_h

    # IP in conn_log table (same label, different table)
    - label: IP
      database: test_zeek
      table: conn_log
      id_column: ip
      property_mappings: {}
      from_node_properties:
        ip: orig_h
        port: orig_p
      to_node_properties:
        ip: resp_h
        port: resp_p

    # Domain node (only in dns_log)
    - label: Domain
      database: test_zeek
      table: dns_log
      id_column: name
      property_mappings: {}
      from_node_properties:
        name: query
      to_node_properties:
        name: query
        resolved_ips: answers

  relationships:
    # DNS_REQUESTED: Source IP requested a domain lookup (dns_log)
    - type: DNS_REQUESTED
      database: test_zeek
      table: dns_log
      from_id: orig_h
      to_id: query
      from_node: IP
      to_node: Domain
      edge_id: uid
      
      property_mappings:
        uid: uid
        timestamp: ts
        dns_server: resp_h
        qtype: qtype_name
        rcode: rcode_name
        answers: answers

    # CONNECTED_TO: Source IP connected to destination IP (conn_log)
    - type: CONNECTED_TO
      database: test_zeek
      table: conn_log
      from_id: orig_h
      to_id: resp_h
      from_node: IP
      to_node: IP
      edge_id: uid
      
      property_mappings:
        uid: uid
        timestamp: ts
        protocol: proto
        service: service
        duration: duration
        orig_bytes: orig_bytes
        resp_bytes: resp_bytes
        conn_state: conn_state
