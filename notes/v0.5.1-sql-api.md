# v0.5.1 Implementation Plan - Production SQL API

**Status**: In Progress  
**Date**: November 19, 2025  
**Feature**: SQL Generation API (`POST /query/sql`)

---

## Overview

Transform the existing debug-only `sql_only` feature into a production-ready API endpoint that allows users to:
- Generate ClickHouse SQL from Cypher queries without execution
- Audit and optimize generated SQL
- Integrate ClickGraph with external SQL tools
- Learn Cypherâ†’SQL translation patterns

---

## API Design

### Endpoint
- **URL**: `POST /query/sql`
- **Purpose**: Generate SQL without execution (production-ready)
- **Deprecates**: `POST /query?sql_only=true` (kept for debugging)

### Request Schema
```rust
pub struct SqlGenerationRequest {
    pub query: String,                              // Cypher query
    pub target_database: SqlDialect,                 // Default: ClickHouse (only supported)
    pub schema_name: Option<String>,                 // Default: "default"
    pub parameters: Option<HashMap<String, Value>>,  // Query parameters
    pub view_parameters: Option<HashMap<String, Value>>, // Multi-tenancy (ClickHouse)
    pub role: Option<String>,                        // RBAC role (ClickHouse)
    pub format_sql: Option<bool>,                    // Pretty-print (future)
    pub include_plan: Option<bool>,                  // Include logical plan
}

pub enum SqlDialect {
    ClickHouse,  // Currently only supported
    // Future: PostgreSQL, DuckDB, MySQL, SQLite
}
```

### Response Schema
```rust
pub struct SqlGenerationResponse {
    pub cypher_query: String,                       // Original query
    pub target_database: String,                     // "clickhouse" (future: "postgresql", etc.)
    pub sql: Vec<String>,                           // SQL statements (array!)
    pub parameters: Option<HashMap<String, Value>>,
    pub view_parameters: Option<HashMap<String, Value>>,
    pub role: Option<String>,
    pub metadata: SqlGenerationMetadata,
    pub logical_plan: Option<String>,
    pub dialect_notes: Option<Vec<String>>,         // Future: optimization hints
}

pub struct SqlGenerationMetadata {
    pub query_type: String,                          // "read", "call", etc.
    pub cache_status: String,                        // "HIT", "MISS"
    pub parse_time_ms: f64,
    pub planning_time_ms: f64,
    pub sql_generation_time_ms: f64,
    pub total_time_ms: f64,
}
```

### Key Design Decision: `sql` as Array

**Why `Vec<String>` instead of `String`:**
1. âœ… **RBAC Support**: Can return `["SET ROLE analyst", "SELECT ..."]`
2. âœ… **Future Multi-Statement**: Can support temp tables, batching
3. âœ… **No Ambiguity**: Avoids semicolon parsing issues
4. âœ… **Clear Execution Order**: Clients execute array in order
5. âœ… **Forward-Compatible**: Ready for query optimization features

---

## Implementation Status

### âœ… Completed

**Data Models** (`src/server/models.rs`):
- âœ… `SqlGenerationRequest` - Request schema
- âœ… `SqlGenerationResponse` - Success response
- âœ… `SqlGenerationMetadata` - Performance metrics
- âœ… `SqlGenerationError` - Error response
- âœ… `ErrorDetails` - Additional error context

**Handler** (`src/server/sql_generation_handler.rs`):
- âœ… Created new handler function `sql_generation_handler`
- âœ… Parse Cypher query
- âœ… Generate SQL for READ queries
- âœ… Generate SQL for CALL queries (PageRank)
- âœ… Handle RBAC (SET ROLE statement)
- âœ… Query cache integration
- âœ… Error handling (Parse, Planning, Render errors)
- âœ… Metadata collection (timing, cache status)
- âœ… Logical plan inclusion (optional)

**Routing** (`src/server/mod.rs`):
- âœ… Added module `sql_generation_handler`
- âœ… Registered route: `POST /query/sql`
- âœ… Proper State<Arc<AppState>> handling

**Build**:
- âœ… Compiles successfully
- âœ… No compilation errors

### ðŸ”¨ In Progress

**Testing** (`scripts/test/test_sql_generation_api.py`):
- âœ… Test script created
- â³ Run manual tests (needs running server)
- â³ Validate all test cases pass

### ðŸ“‹ TODO

1. **Manual Testing** (30 min):
   - [ ] Start server: `cargo run --bin clickgraph`
   - [ ] Run test script: `python scripts/test/test_sql_generation_api.py`
   - [ ] Fix any issues found
   - [ ] Validate all 7 tests pass

2. **Documentation** (1 hour):
   - [ ] Update `docs/api.md` with `/query/sql` endpoint
   - [ ] Add examples (curl, Python, PowerShell)
   - [ ] Document use cases
   - [ ] Update `docs/wiki/API-Reference-HTTP.md`
   - [ ] Add troubleshooting guide

3. **Integration Tests** (1 hour):
   - [ ] Add test file: `tests/integration/test_sql_generation_api.py`
   - [ ] Test basic queries
   - [ ] Test RBAC functionality
   - [ ] Test error handling
   - [ ] Test cache behavior

4. **CHANGELOG** (15 min):
   - [ ] Create v0.5.1 section
   - [ ] Document new `/query/sql` endpoint
   - [ ] List all features and use cases

5. **Optional Enhancements**:
   - [ ] SQL pretty-printing (`format_sql: true`)
   - [ ] Response compression for large SQL
   - [ ] SQL syntax highlighting in responses

---

## Use Cases

### 1. SQL Audit & Review
```bash
curl -X POST http://localhost:8080/query/sql \
  -H "Content-Type: application/json" \
  -d '{"query": "MATCH (u:User) WHERE u.age > 25 RETURN u.name"}'
```

### 2. Integration with External Tools
```python
# Get SQL, execute in external ClickHouse client
response = requests.post('http://localhost:8080/query/sql', 
    json={'query': 'MATCH (u:User) RETURN u.name LIMIT 10'})
sql_statements = response.json()['sql']

for stmt in sql_statements:
    external_ch_client.execute(stmt)
```

### 3. Query Optimization
```bash
# Get SQL with RBAC, add custom ClickHouse settings
curl -X POST http://localhost:8080/query/sql \
  -d '{"query": "MATCH (u:User)-[*1..3]->(f) RETURN count(*)", "role": "analyst"}' \
  | jq -r '.sql[]'

# Then manually optimize with ClickHouse hints
```

### 4. Learning & Documentation
```bash
# See how Cypher maps to SQL with logical plan
curl -X POST http://localhost:8080/query/sql \
  -d '{"query": "MATCH (a)-[:FOLLOWS*1..3]->(b) RETURN a.name", "include_plan": true}'
```

---

## Next Steps

1. **Immediate**: Run manual tests to validate functionality
2. **Short-term**: Add documentation and integration tests
3. **v0.5.2**: Consider adding subgraph extraction patterns
4. **v0.5.3**: Add SQL formatting and additional polish

---

## Technical Notes

### Cache Behavior
- Uses same `QueryCacheKey` as query execution
- Caches SQL template (not substituted parameters)
- Cache hit returns instantly (<1ms)

### Error Handling
- Returns HTTP 200 with error JSON (not 4xx/5xx)
- Provides detailed error types: ParseError, PlanningError, RenderError
- Includes hints for common mistakes

### Performance
- Typical response: 5-15ms (cache miss)
- Cache hit: <1ms
- No ClickHouse execution overhead
